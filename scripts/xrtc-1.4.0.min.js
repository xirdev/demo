var xRtc={ajax:{}};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Ajax={ajax:function(a,c,d,f){var e,r;r=b.Class.proxy(this);try{e=new XMLHttpRequest}catch(v){try{e=new ActiveXObject("Msxml2.XMLHTTP")}catch(n){try{e=new ActiveXObject("Microsoft.XMLHTTP")}catch(s){this._logger&&(r=new b.CommonError("ajax","XMLHttpRequest is not supported"),this._logger.error("ajax",r));return}}}this._logger&&this._logger.debug("ajax",a,d);c=c.toUpperCase();try{var w=!1;"GET"===c?(e.open(c,a+"?"+d,!0),d=""):(e.open(c,
a,!0),e.setRequestHeader("method",c+" "+a+" HTTP/1.1"),e.setRequestHeader("content-type","application/x-www-form-urlencoded"));e.onreadystatechange=r(function(){4!=e.readyState||w||(w=!0,this._logger&&this._logger.debug("ajax",e),"function"===typeof f&&f(e.responseText))});e.send(d)}catch(E){throw r=new b.CommonError("ajax","XMLHttpRequest exception",E),r.data={url:a,method:c,params:d},this._logger&&this._logger.error("ajax",r),r;}}}})(window);xRtc.baseClass={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.Class=function(b,k,c){b[k]=c;var d=b[k];d.fn=d.prototype;d.fn.className=k;d.extend=function(b){var c=b.extended;a.xRtc.Class.extend(d,b);c&&c(d)}};a.xRtc.Class.extend=function(b){for(var a=Array.prototype.slice.call(arguments,1),c=0,d=a.length;c<d;c++){var f=a[c],e;for(e in f)b[e]=f[e]}};a.xRtc.Class.property=function(b,a,c,d){"function"===typeof c&&b.__defineGetter__(a,c);"function"===typeof d&&b.__defineSetter__(a,d)};a.xRtc.Class.proxy=
function(b){return function(a){var c=[];1<arguments.length&&(c=Array.prototype.slice.call(arguments,1));return function(){for(var d=Array.prototype.slice.call(arguments),f=0;f<c.length;f++)d.push(c[f]);a.apply(b,d)}}}})(window);xRtc.common={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.webrtc={getUserMedia:(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia||navigator.getUserMedia).bind(navigator),RTCPeerConnection:a.mozRTCPeerConnection||a.webkitRTCPeerConnection||a.RTCPeerConnection,RTCIceCandidate:a.mozRTCIceCandidate||a.RTCIceCandidate,RTCSessionDescription:a.mozRTCSessionDescription||a.RTCSessionDescription,URL:a.webkitURL||a.msURL||a.oURL||a.URL,MediaStream:a.mozMediaStream||a.webkitMediaStream||
a.MediaStream,supportedBrowsers:{chrome:"chrome",firefox:"firefox"}};b.webrtc.detectedBrowser=navigator.mozGetUserMedia?b.webrtc.supportedBrowsers.firefox:b.webrtc.supportedBrowsers.chrome;b.webrtc.detectedBrowserVersion=b.webrtc.detectedBrowser===b.webrtc.supportedBrowsers.firefox?parseInt(a.navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]):parseInt(a.navigator.userAgent.match(/Chrom(e|ium)\/([0-9]+)\./)[2]);xRtc.utils={newGuid:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,
function(b){var c=16*Math.random()|0;return("x"==b?c:c&3|8).toString(16)})}}})(window);xRtc.commonError={};(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a=a.xRtc;a.Class(a,"CommonError",function(b,a,c){this.method=b;this.message=a;this.error=c})})(window);xRtc.eventDispatcher={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});a.xRtc.EventDispatcher={on:function(b,a){this._logger&&this._logger.info("on",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];this._events[b].push(a);return this},off:function(b){this._logger&&this._logger.info("off",arguments);this._events=this._events||{};this._events[b]=this._events[b]||[];delete this._events[b];return this},trigger:function(b){this._logger&&this._logger.info("trigger",arguments);this._events=this._events||
{};var a=this._events[b];if(!a)return this._logger.warning("trigger","Trying to call event which is not listening. Event name is '"+b+"'"),this;for(var c=Array.prototype.slice.call(arguments,1),d=0,f=a.length;d<f;d++)a[d].apply(null,c);return this}}})(window);xRtc.logger={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Logger",function(a){function c(){for(var b=[],a,e=0,r=arguments.length;e<r;e++)if(a=arguments[e],"object"===typeof a&&a instanceof Object&&"undefined"!==typeof a.length){a=c.apply(null,Array.prototype.slice.call(a));for(var k=0,n=a.length;k<n;k++)b.push(a[k])}else b.push(a);return b}b.Class.extend(this,{info:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.info)"string"===typeof d?console.info("Info:\t\t",
a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.info("Info:\t\t",c(Array.prototype.slice.call(arguments)))},debug:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.debug)"string"===typeof d?console.debug("Debug:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.debug("Debug:\t\t",c(Array.prototype.slice.call(arguments)))},test:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.test)"string"===typeof d?
console.debug("Test:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.debug("Test:\t\t",c(Array.prototype.slice.call(arguments)))},warning:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.warning)"string"===typeof d?console.warn("Warning:\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.warn("Warning:\t",c(Array.prototype.slice.call(arguments)))},error:function(d){if(!0===b.Logger.level||"object"===typeof b.Logger.level&&b.Logger.level.error)"string"===
typeof d?console.error("Error:\t\t",a+"."+d,c(Array.prototype.slice.call(arguments,1))):console.error("Error:\t\t",c(Array.prototype.slice.call(arguments)))}})});b.Logger.extend({level:!1,enable:function(b){this.level="undefined"===typeof b?!0:b},disable:function(){this.level=!1}})})(window);xRtc.authManager={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"AuthManager",function(){function a(b){return["domain="+b.domain,"application="+b.application,"room="+b.room,"username="+b.name,"password="+b.password]}function c(a,c,d){var f=this;try{e.debug("getToken",a);""===a&&(e.error("getToken","Server returned an empty response."),f.trigger(b.AuthManager.events.serverError,"Server returned an empty response."));try{a=JSON.parse(a),e.debug("getToken",a)}catch(w){throw e.error("getToken",a),
w;}if(a&&a.e&&""!=a.e){var k=new b.CommonError("getToken",a.e);e.error("getToken",k);f.trigger(b.AuthManager.events.serverError,k)}else{var t=a.d.token;t?(e.info("getToken",t),"function"===typeof d&&d(t)):(e.error("getToken",a.d),f.trigger(b.AuthManager.events.serverError,a.d))}}catch(l){e.error("getToken. The request will be repeated after "+b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",l),setTimeout(function(){f.getToken(c,d)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}
function d(a,c,d){var f=this;try{if(a=JSON.parse(a),e.debug("getIceServers",a),a&&a.e&&""!=a.e){var w=new b.CommonError("getIceServers",a.e);e.error("getIceServers",w);f.trigger(b.AuthManager.events.serverError,w)}else{var k=a.d.iceServers?a.d.iceServers.map(function(b){var a={};b.url&&(a.url=b.url);b.credential&&(a.credential=b.credential);b.username&&(a.username=b.username);return a}):[];e.info("getIceServers",k);"function"===typeof d&&d(k)}}catch(t){e.error("getIceServers. The request will be repeated after "+
b.AuthManager.settings.unsuccessfulRequestRepeatTimeout/1E3+" sec.",t),setTimeout(function(){f.getIceServers(c,d)},b.AuthManager.settings.unsuccessfulRequestRepeatTimeout)}}var f=b.Class.proxy(this),e=new b.Logger(this.className);b.Class.extend(this,b.Ajax,b.EventDispatcher,{_logger:e,getToken:function(e,d){var n=b.AuthManager.settings.tokenHandler,s=a.call(this,e).join("&");this.ajax(n,"POST",s,f(c,e,d))},getIceServers:function(c,e){var n=b.AuthManager.settings.iceHandler,s=a.call(this,c).join("&");
this.ajax(n,"POST",s,f(d,c,e))}})});b.AuthManager.extend({events:{serverError:"servererror"},settings:{unsuccessfulRequestRepeatTimeout:5E3,tokenHandler:"https://service.xirsys.com/getToken",iceHandler:"https://service.xirsys.com/getIceServers"}})})(window);xRtc.dataChannel={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"DataChannel",function(a,c){var d=b.Class.proxy(this),f=new b.Logger(this.className),e=b.DataChannel.events;a.onopen=d(function(b){b={event:b};f.debug("open",b);this.trigger(e.open,b)});a.onmessage=d(function(b){b=JSON.parse(b.data);f.debug("message",b);this.trigger(e.receivedMessage,b)});a.onclose=d(function(b){b={event:b};f.debug("close",b);this.trigger(e.close,b)});a.onerror=d(function(a){a=new b.CommonError("onerror","DataChannel error.",
a);f.error("error",a);this.trigger(e.error,a)});a.ondatachannel=d(function(b){b={event:b};f.debug("datachannel",b);this.trigger(e.dataChannel,b)});b.Class.extend(this,b.EventDispatcher,{_logger:f,send:function(c){f.info("send",arguments);try{var d={message:c};a.send(JSON.stringify(d));this.trigger(e.sentMessage,d)}catch(n){d=new b.CommonError("onerror",'DataChannel sending error. Channel state is "'+this.getState()+'"',n),f.error("error",d),this.trigger(e.error,d)}},getRemoteUser:function(){return c},
getName:function(){return a.label},getState:function(){return a.readyState.toLowerCase()}})});b.DataChannel.extend({events:{open:"open",sentMessage:"sentMessage",receivedMessage:"receivedMessage",close:"close",error:"error",dataChannel:"datachannel"},states:{connecting:"connecting",open:"open",closing:"closing",closed:"closed"}})})(window);xRtc.handshakeController={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"HandshakeController",function(){var a=new b.Logger(this.className);b.Class.extend(this,b.EventDispatcher,{_logger:a,sendIce:function(a,d,f){this.trigger(b.HandshakeController.events.sendIce,a,d,f)},sendOffer:function(a,d,f){this.trigger(b.HandshakeController.events.sendOffer,a,d,f)},sendAnswer:function(a,d,f){this.trigger(b.HandshakeController.events.sendAnswer,a,d,f)},sendBye:function(a,d,f){this.trigger(b.HandshakeController.events.sendBye,a,
d,f)}})});b.HandshakeController.extend({events:{sendIce:"sendice",sendOffer:"sendoffer",sendAnswer:"sendanswer",sendBye:"sendbye",receiveIce:"receiveice",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveBye:"receivebye"}})})(window);xRtc.serverConnector={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"ServerConnector",function(k){function c(a){if(!x){var c=new b.CommonError("send","Trying to call method without established connection","WebSocket is not connected!");l.error("send",c);throw c;}c={eventName:a.eventName};"undefined"!==typeof a.data&&(c.data=a.data);"undefined"!==typeof a.targetUserId&&(c.targetUserId=a.targetUserId.toString());a=JSON.stringify(c);l.debug("send",c,a);x.send(a)}function d(a,c){try{if(a=JSON.parse(a),
l.debug("getWebSocketURL",a),a&&a.e&&""!=a.e){var e=new b.CommonError("getWebSocketURL","Error occured while getting the URL of WebSockets",a.e);l.error("getWebSocketURL",e);this.trigger(g.serverError,{error:e})}else{var f=a.d.value;l.info("getWebSocketURL",f);"function"===typeof c&&c(f)}}catch(w){this.ajax(b.ServerConnector.settings.URL,"POST","",t(d,c))}}function f(b,a){x=new WebSocket(b+"/"+encodeURIComponent(a));x.onopen=t(e);x.onclose=t(r);x.onerror=t(v);x.onmessage=t(n)}function e(b){b={event:b};
l.debug("open",b);q&&(u=E.call(this,q));this.trigger(g.connectionOpen,b)}function r(b){u&&(a.clearInterval(u),u=null);b={event:b};l.debug("close",b);this.trigger(g.connectionClose,b);x=null}function v(a){a=new b.CommonError("onerror","WebSocket has got an error",a);l.error("error",a);this.trigger(g.connectionError,{error:a})}function n(b){var a={message:b};l.debug("message",a);this.trigger(g.message,a);if(s(b))if(b=w(b),a=b.type,a==g.usersUpdated||a==g.userConnected||a==g.userDisconnected)if(a==g.usersUpdated){for(var a=
[],c=0,e=b.message.users.length;c<e;c++)a.push({id:b.message.users[c],name:b.message.users[c]});this.trigger(g.usersUpdated,{users:a})}else a==g.userConnected?this.trigger(g.userConnected,{user:{id:b.message,name:b.message}}):a==g.userDisconnected&&this.trigger(g.userDisconnected,{user:{id:b.message,name:b.message}});else if(a==g.receiveOffer||a==g.receiveAnswer||a==g.receiveIce||a==g.receiveBye)a==g.receiveOffer?this.trigger(g.receiveOffer,{senderId:b.userid,receiverId:b.message.targetUserId,connectionId:b.message.data.connectionId,
offer:b.message.data.offer.offer,iceServers:b.message.data.offer.iceServers,connectionType:b.message.data.offer.connectionType,connectionData:b.message.data.offer.connectionData}):a==g.receiveAnswer?this.trigger(g.receiveAnswer,{senderId:b.userid,connectionId:b.message.data.connectionId,answer:b.message.data.answer.answer,acceptData:b.message.data.answer.acceptData}):a==g.receiveIce?this.trigger(g.receiveIce,{senderId:b.userid,connectionId:b.message.data.connectionId,iceCandidate:b.message.data.iceCandidate}):
a==g.receiveBye&&this.trigger(g.receiveBye,{senderId:b.userid,connectionId:b.message.data.connectionId,byeData:b.message.data.byeData})}function s(b){var a=!0;'"Token invalid"'===b.data&&(a=!1,this.trigger(g.tokenInvalid,{token:y}));return a}function w(a){var c;try{c=JSON.parse(a.data)}catch(e){c=null;var d=new b.CommonError("parseServerMessage","Message format error",e);l.error("parseServerMessage",d,a);this.trigger(g.messageFormatError,{error:d})}return c}function E(b){return a.setInterval(function(){c.call(this,
{})},b)}var t=b.Class.proxy(this),l=new b.Logger(this.className),x=null,y=null,q=k?k.pingInterval:5E3,u=null,g=b.ServerConnector.events;b.Class.extend(this,b.EventDispatcher,b.Ajax,{_logger:l,connect:function(a){y=a;a=t(f,a);this.ajax(b.ServerConnector.settings.URL,"POST","",t(d,a))},disconnect:function(){x?(x.close(),y=x=null,l.info("disconnect","Connection with WS has been broken")):l.debug("disconnect","Connection with WS has not been established yet")},sendOffer:function(b,a,e){c({eventName:g.receiveOffer,
targetUserId:b,data:{connectionId:a,offer:e||{}}})},sendAnswer:function(b,a,e){c({eventName:g.receiveAnswer,targetUserId:b,data:{connectionId:a,answer:e||{}}})},sendIce:function(b,a,e){c({eventName:g.receiveIce,targetUserId:b,data:{connectionId:a,iceCandidate:e}})},sendBye:function(b,a,e){c({eventName:g.receiveBye,targetUserId:b,data:{connectionId:a,byeData:e||{}}})}})});b.ServerConnector.extend({events:{connectionOpen:"connectionopen",connectionClose:"connectionclose",connectionError:"connectionerror",
message:"message",messageFormatError:"messageformaterror",serverError:"servererror",tokenInvalid:"tokeninvalid",receiveOffer:"receiveoffer",receiveAnswer:"receiveanswer",receiveIce:"receiveice",receiveBye:"receivebye",usersUpdated:"peers",userConnected:"peer_connected",userDisconnected:"peer_removed"},settings:{URL:"https://service.xirsys.com/wsList?secure=1"}})})(window);xRtc.stream={};
(function(a,b){var k=b.webrtc;b.Class(b,"Stream",function(c){function d(){if(k.detectedBrowser===k.supportedBrowsers.firefox&&22>k.detectedBrowserVersion)throw new b.CommonError("setVideoEnabled","Media track muting is not supported if your Firefox browser version less then 22.");}var f=b.Class.proxy(this),e=new b.Logger(this.className),r=b.Stream.events,v=null;b.Class.property(this,"videoEnabled",function(){var b=c.getVideoTracks();return this.videoAvailable&&b[0].enabled},function(b){d();for(var a=
c.getVideoTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"audioEnabled",function(){var b=c.getAudioTracks();return this.audioAvailable&&b[0].enabled},function(b){d();for(var a=c.getAudioTracks(),e=0,f=a.length;e<f;e++)a[e].enabled=b});b.Class.property(this,"videoAvailable",function(){return 0<c.getVideoTracks().length});b.Class.property(this,"audioAvailable",function(){return 0<c.getAudioTracks().length});c.onended=f(function(b){b={id:b.srcElement.id};e.debug("ended",b);this.trigger(r.ended,
b)});b.Class.extend(this,b.EventDispatcher,{_logger:e,getStream:function(){return c},stop:function(){c.stop()},getId:function(){v||(v=c.id?c.id:b.utils.newGuid());return v},getURL:function(){return k.URL.createObjectURL(c)},assignTo:function(b){this.videoAvailable||this.audioAvailable||0<c.currentTime?(k.detectedBrowser===k.supportedBrowsers.firefox?b.mozSrcObject=c:b.src=this.getURL(),b.play()):a.setTimeout(f(this.assignTo,b),100)}})});b.Stream.extend({events:{ended:"ended"}})})(window,xRtc);xRtc.connection={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,k={},c=b.webrtc;b.Class(k,"IceCandidateFilter",function(a,c){b.Class.proxy(this);new b.Logger(this.className);var e=a||b.Connection.connectionTypes["default"],k=c&&c.iceServers||null,v=/(\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})/g;b.Class.extend(this,{getType:function(){return e},isAllowed:function(a){var c=!0;switch(e){case b.Connection.connectionTypes.direct:c=n.local(a)||n.stun(a);break;case b.Connection.connectionTypes.server:n.stun(a)?s.stun2turn(a):
n.turn(a)?s.turn2turn(a):c=!1}return c},filterSDP:function(a){var c=a;e===b.Connection.connectionTypes.server?c=a.replace(/a=candidate:.*((typ host)|(typ srflx)).*\r\n/g,""):e===b.Connection.connectionTypes.direct&&(c=a.replace(/a=candidate:.*typ relay.*\r\n/g,""));return c}});var n={local:function(b){return/typ host/.test(b.candidate)},stun:function(b){return/typ srflx/.test(b.candidate)},turn:function(b){return/typ relay/.test(b.candidate)}},s={turn2turn:function(b){b.candidate=b.candidate.replace(v,
b.candidate.match(v)[0])},stun2turn:function(b){var a;a:{if(k)for(a=0;a<k.length;a++){var c=k[a];if("credential"in c){a=c.url.split("@")[1];break a}}a=null}a?b.candidate=b.candidate.replace(v,a):s.turn2turn(b)}}});b.Class(b,"Connection",function(d,f,e,r,v,n){function s(a){var c=new b.CommonError(a,"The method can be called on '"+b.Room.events.connectionCreated+"' event of the xRtc.Room. Use xRtc.Room.events.connectionCreated for access the event name.");m.error(a,c)}function w(d,f){function k(){if("function"===
typeof f)try{f()}catch(b){}}function n(b){function a(b,c){var e=b;b[b.length-1]===c&&(e=b.substring(0,b.length-1));return e}for(var e=[],h=function(b){var e;if(c.detectedBrowser==c.supportedBrowsers.chrome){var h=b.url;e=b.username;b=b.credential;var d=null,f=h.split(":");0===f[0].indexOf("stun")?d={url:a(h,"/")}:0===f[0].indexOf("turn")&&(28>c.detectedBrowserVersion?(h=h.split("turn:"),d={url:"turn:"+e+"@"+h[1],credential:b}):d={url:a(h,"/"),credential:b,username:e})}else h=b.url,e=b.username,b=
b.credential,d=null,f=h.split(":"),0===f[0].indexOf("stun")?d={url:a(h,"/")}:0!==f[0].indexOf("turn")||-1===h.indexOf("transport=udp")&&-1!==h.indexOf("?transport")||(h=h.split("?"),d={url:a(h[0],"/"),credential:b,username:e});return e=d},d=0,L=b.length;d<L;d++){var f=h(b[d]);f&&e.push(f)}return e}function r(d){var f=this;d=n(d);h=new c.RTCPeerConnection(d&&0<d.length?{iceServers:d}:null,b.Connection.settings.peerConnectionOptions);m.info("initPeerConnection","PeerConnection created.");h.onicecandidate=
p(function(b){b.candidate&&(b=JSON.parse(JSON.stringify(b.candidate)),I.isAllowed(b)&&(J.push(b),O&&t.call(this)))});h.onstatechange=h.onsignalingstatechange=p(function(a){m.debug("onConnectionStateChange",a);this.trigger(b.Connection.events.stateChanged,{connection:this,state:this.getState()})});if(c.detectedBrowser===c.supportedBrowsers.firefox&&24>c.detectedBrowserVersion){var L=this.getState();P=a.setInterval(function(){var a=f.getState();a!=L&&(m.debug("setInterval -> xrtc.Connection.events.stateChanged",
a),L=a,f.trigger(b.Connection.events.stateChanged,{connection:f,state:L}))},500)}h.onicechange=h.oniceconnectionstatechange=p(function(c){c=F.call(f);m.debug("onIceStateChange",(new Date).getTime(),c);C&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout are clearing. ID = '"+C+"'"),a.clearTimeout(C),C=null,m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout was cleared. ID = '"+C+"'"));"connected"===c?f.trigger(b.Connection.events.connectionEstablished,
{connection:f,user:e}):"disconnected"===c&&(m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout(10sec.) was started."),C=a.setTimeout(function(){m.debug("onIceStateChange",(new Date).getTime(),"ice state equals 'disconnected' so closePeerConnection was called. Timeout is 10sec and it is expired.");g.call(f);a.clearInterval(C);C=null},1E4),m.debug("onIceStateChange",(new Date).getTime(),"checkDisconnectedIceStateTimeout ID ='"+C+"'"))});h.ondatachannel=function(a){a=new b.DataChannel(a.channel,
e);G.push(a);f.trigger(b.Connection.events.dataChannelCreated,{connection:f,channel:a})};h.onaddstream=p(function(a){a=new b.Stream(a.stream);B.push(a);a={user:e,connection:this,stream:a};m.debug("addRemoteStream",a);this.trigger(b.Connection.events.remoteStreamAdded,a)});h.onclosedconnection=function(b){m.debug("peerConnection.onclosedconnection",b);g.call(f)};d=0;for(var l=z.length;d<l;d++)h.addStream(z[d].getStream());d=0;for(l=M.length;d<l;d++)E.call(this,M[d]);k()}e=d;h?k():l.call(this,p(r))}
function E(a){try{var d=h.createDataChannel(a,c.detectedBrowser===c.supportedBrowsers.chrome?{reliable:!1}:{}),f=new b.DataChannel(d,e);G.push(f);this.trigger(b.Connection.events.dataChannelCreated,{connection:this,channel:f})}catch(M){d=new b.CommonError("createDataChannel","Can't create DataChannel.",M),m.error("createDataChannel",d),this.trigger(b.Connection.events.dataChannelCreationError,{connection:this,channelName:a,error:d})}}function t(){m.debug("sendIceCandidates",'Sending "'+J.length+'" ice candidates.');
for(var a=0,c=J.length;a<c;a++){var d=J[a];K.sendIce(e.id,N,JSON.stringify(d));this.trigger(b.Connection.events.iceSent,{connection:this,iceCandidate:d})}J=[]}function l(b){"function"===typeof b&&(D?b(D):A.getIceServers(H,function(a){D=a;b(D)}))}function x(a){m.debug("Ice candidate was received.",a);a=new c.RTCIceCandidate(JSON.parse(a.iceCandidate));h.addIceCandidate(a);this.trigger(b.Connection.events.iceAdded,{connection:this,iceCandidate:a})}function y(a){this.trigger(b.Connection.events.offerReceived,
{connection:this,user:e,offerData:a});this.trigger(b.Connection.events.connectionOpening,{connection:this,user:e});m.debug("Offer was received.",a);D=a.iceServers;w.call(this,e,p(function(){m.debug("receiveOffer",a);I=new k.IceCandidateFilter(a.connectionType,D);var d=JSON.parse(a.offer),d=new c.RTCSessionDescription(d);h.setRemoteDescription(d);h.createAnswer(p(function(d){c.detectedBrowser===c.supportedBrowsers.firefox&&(d.sdp=I.filterSDP(d.sdp));h.setLocalDescription(d);var f={answer:JSON.stringify(d),
acceptData:a.acceptData};m.debug("sendAnswer",a,d);K.sendAnswer(e.id,N,f);this.trigger(b.Connection.events.answerSent,{connection:this,user:e,answerData:f});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e});O=!0;t.call(this)}),p(function(a){a=new b.CommonError("sendAnswer","Cannot create WebRTC answer",a);m.error("sendAnswer",a);this.trigger(b.Connection.events.createAnswerError,{connection:this,error:a})}),b.Connection.settings.answerOptions)}))}function q(a){m.debug("Answer was received.",
a);O=!0;t.call(this);a=JSON.parse(a.answer);a=new c.RTCSessionDescription(a);h.setRemoteDescription(a);this.trigger(b.Connection.events.answerReceived,{connection:this,user:e,answerData:{answer:a}});this.trigger(b.Connection.events.connectionEstablishing,{connection:this,user:e})}function u(){g.call(this)}function g(){c.detectedBrowser===c.supportedBrowsers.firefox&&P&&(a.clearInterval(P),P=null);if(h){h.onicecandidate=null;h.close();h=null;J=[];D=null;Q=O=!1;var d={connection:this,user:e};e=null;
this.trigger(b.Connection.events.connectionClosed,d)}}function F(){return h&&(h.iceConnectionState||h.iceState)||"notinitialized"}var p=b.Class.proxy(this),m=new b.Logger(this.className),H=f,A=v||new xRtc.AuthManager,z=[],B=[],G=[],M=[],h=null,P=null,C=null,K=r,I=null,D=null,O=!1,J=[],N=d,Q=!1;(function(){var a=b.HandshakeController.events;K.on(a.receiveIce,p(x)).on(a.receiveOffer,p(y)).on(a.receiveAnswer,p(q)).on(a.receiveBye,p(u))}).call(this);b.Class.extend(this,b.EventDispatcher,{_logger:m,getId:function(){return N},
getRemoteUser:function(){return e},_open:function(a){Q=!0;var d=this,f={};b.Class.extend(f,b.Connection.settings.offerOptions);a&&a.offer&&b.Class.extend(f,a.offer);d.trigger(b.Connection.events.connectionOpening,{connection:d,user:e});w.call(d,e,function(){I=new k.IceCandidateFilter(a&&a.connectionType||null,D);h.createOffer(p(function(a){if(h){c.detectedBrowser===c.supportedBrowsers.firefox&&27>=c.detectedBrowserVersion&&(a.sdp=I.filterSDP(a.sdp));m.debug("onCreateOfferSuccess",a);h.setLocalDescription(a);
c.detectedBrowser===c.supportedBrowsers.firefox&&21>=c.detectedBrowserVersion&&(a.sdp=-1==a.sdp.indexOf("a=crypto")?a.sdp.replace(/c=IN/g,"a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\r\nc=IN"):a.sdp);var f={offer:JSON.stringify(a),connectionData:n,connectionType:I.getType(),iceServers:D};m.debug("sendOffer",e.id,a);K.sendOffer(e.id,N,f);d.trigger(b.Connection.events.offerSent,{connection:this,user:e,offerData:f})}}),p(function(a){a=new b.CommonError("startSession",
"Cannot create WebRTC offer",a);m.error("onCreateOfferError",a);d.trigger(b.Connection.events.createOfferError,{connection:d,error:a})}),f)})},close:function(b){K&&e&&K.sendBye(e.id,N,b);g.call(this)},addStream:function(a){Q&&s("addStream");z.push(a);a={connection:this,stream:a,user:{id:H.name,name:H.name}};m.debug("addLocalStream",a);this.trigger(b.Connection.events.localStreamAdded,a)},createDataChannel:function(b){Q&&s("createDataChannel");M.push(b)},getData:function(){return n},getState:function(){var b=
0<z.length;return{notinitialized:b?"ready":"not-ready","new":b?"ready":"not-ready",opening:"connecting",active:"connected",closing:"disconnecting",closed:b?"ready":"not-ready",stable:"connected","have-local-offer":"ready","have-remote-offer":"connecting"}[h&&(h.signalingState||h.readyState)||"notinitialized"]},getLocalStreams:function(){return z.map(function(b){return b})},getRemoteStreams:function(){return B.map(function(b){return b})},getDataChannels:function(){return G.map(function(b){return b})}})});
b.Connection.extend({events:{connectionOpening:"connectionopening",connectionEstablishing:"connectionestablishing",connectionEstablished:"connectionestablished",connectionClosed:"connectionclosed",localStreamAdded:"localstreamadded",remoteStreamAdded:"remotestreamadded",dataChannelCreated:"datachannelcreated",dataChannelCreationError:"datachannelcreationerror",stateChanged:"statechanged",createOfferError:"createoffererror",offerSent:"offersent",offerReceived:"offerreceived",createAnswerError:"createanswererror",
answerSent:"answersent",answerReceived:"answerreceived",iceSent:"icesent",iceAdded:"iceadded"},connectionTypes:{"default":"default",direct:"direct",server:"server"},settings:{offerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},answerOptions:{optional:[],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}},peerConnectionOptions:{optional:[{RtpDataChannels:!0},{DtlsSrtpKeyAgreement:!0}]}}});c.RTCPeerConnection.prototype&&!c.RTCPeerConnection.prototype.getLocalStreams&&
b.Class.extend(c.RTCPeerConnection.prototype,{getLocalStreams:function(){return this.localStreams},getRemoteStreams:function(){return this.remoteStreams}});c.MediaStream.prototype.getVideoTracks||(c.detectedBrowser===c.supportedBrowsers.firefox?b.Class.extend(c.MediaStream.prototype,{getVideoTracks:function(){return[]},getAudioTracks:function(){return[]}}):b.Class.extend(c.MediaStream.prototype,{getVideoTracks:function(){return this.videoTracks},getAudioTracks:function(){return this.audioTracks}}))})(window);xRtc.room={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc;b.Class(b,"Room",function(a,c,d){function f(){var a=this;g||(A.on(q.connectionOpen,l(function(a){this.trigger(b.Room.events.enter)})).on(q.connectionClose,l(function(a){this.trigger(b.Room.events.leave)})).on(q.tokenInvalid,l(function(a){this.trigger(b.Room.events.tokenInvalid,a)})).on(q.usersUpdated,l(function(a){u=a.users;u.sort(n);this.trigger(b.Room.events.usersUpdated,{users:this.getUsers()})})).on(q.userConnected,l(function(a){u.push(a.user);
u.sort(n);this.trigger(b.Room.events.userConnected,{user:a.user})})).on(q.userDisconnected,l(function(a){u.splice(t(u,a.user.id),1);u.sort(n);this.trigger(b.Room.events.userDisconnected,{user:a.user})})).on(q.receiveOffer,l(e)).on(q.receiveBye,l(r)).on(q.receiveAnswer,function(c){if(c.senderId&&c.connectionId){var d=s(c.senderId);if(d){var e=B[c.connectionId];e?e.userId===d.id&&(a.trigger(b.Room.events.connectionAccepted,{user:d,connection:w(c.connectionId),data:c.acceptData}),e.hc.trigger(y.receiveAnswer,
{connectionId:c.connectionId,answer:c.answer})):A.sendBye(c.senderId,c.connectionId,{type:G.decline,data:"Remote connection not found."})}}}).on(q.receiveIce,function(b){if(b.senderId&&b.connectionId){var a=B[b.connectionId];a&&a.userId===b.senderId&&a.hc.trigger(y.receiveIce,{iceCandidate:b.iceCandidate,connectionId:b.connectionId})}}),g=!0)}function e(a){function c(b){v.call(e,a.connectionId,m,s(a.senderId),a.connectionData,function(c){c.handshakeController.trigger(y.receiveOffer,{offer:a.offer,
iceServers:a.iceServers,connectionType:a.connectionType,connectionId:a.connectionId,connectionData:a.connectionData,acceptData:b})})}function d(b){A.sendBye(a.senderId,a.connectionId,{type:G.decline,data:b})}if(a.senderId&&a.connectionId){var e=this,f={user:s(a.senderId)};F.autoReply||(f.data=a.connectionData,f.accept=l(c),f.decline=l(d));B[a.connectionId]={userId:a.senderId,hc:null};this.trigger(b.Room.events.incomingConnection,f);F.autoReply&&c.call(e)}}function r(a){if(a.senderId&&a.connectionId){var c=
s(a.senderId);if(c){var d=B[a.connectionId];d&&d.userId===c.id&&((a.byeData&&a.byeData.type===G.decline||!d.hc)&&this.trigger(b.Room.events.connectionDeclined,{user:c,connection:w(a.connectionId),data:a.byeData}),d.hc&&d.hc.trigger(y.receiveBye))}}}function v(a,c,d,e,f){var g=new b.HandshakeController;c=new xRtc.Connection(a,c,d,g,H,e);B[a]?B[a].hc=g:B[a]={userId:d.id,hc:g};g.on(y.sendOffer,l(function(a,b,c){A.sendOffer(a,b,c)})).on(y.sendAnswer,l(function(a,b,c){A.sendAnswer(a,b,c)})).on(y.sendIce,
l(function(a,b,c){A.sendIce(a,b,c)})).on(y.sendBye,l(function(a,b,c){A.sendBye(a,b,c)}));c.on(b.Connection.events.connectionClosed,function(){z.splice(E(z,a),1);delete B[a]});z.push(c);this.trigger(b.Room.events.connectionCreated,{user:d,connection:c});"function"===typeof f&&f({connection:c,handshakeController:g})}function n(a,b){var c=0;a.name<b.name?c=-1:a.name>b.name&&(c=1);return c}function s(a){for(var b=null,c=0,d=u.length;c<d;c++)if(u[c].id===a){b=u[c];break}return b}function w(a){for(var b=
null,c=0,d=z.length;c<d;c++)if(z[c].getId()===a){b=z[c];break}return b}function E(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)if(a[d].getId()===b){c=d;break}return c}function t(a,b){for(var c=-1,d=0,e=a.length;d<e;d++)a[d].id===b&&(c=d);return c}var l=b.Class.proxy(this),x=new b.Logger(this.className),y=b.HandshakeController.events,q=b.ServerConnector.events,u=[],g=!1,F={},p={},m=null,H=c||new xRtc.AuthManager,A=d||new b.ServerConnector,z=[],B={},G={decline:"decline"};b.Class.extend(p,b.Room.settings.info);
"string"===typeof a?p.name=a:b.Class.extend(p,a);b.Class.extend(this,b.EventDispatcher,{_logger:x,enter:function(a,c){var d="",e="";if(!a)throw new b.CommonError("enter","User credentials should be specified.");"string"===typeof a?d=a:(d=a.username,e=a.password);f.call(this);b.Class.extend(F,b.Room.settings.enterOptions);c&&b.Class.extend(F,c);m={domain:p.domain,application:p.application,room:p.name,name:d,password:e};H.getToken(m,function(a){p.user={id:null,name:d};A.connect(a)})},leave:function(){A.on(b.ServerConnector.events.connectionClose,
function(){g&&(A.off(q.connectionOpen).off(q.connectionClose).off(q.tokenInvalid).off(q.usersUpdated).off(q.userConnected).off(q.userDisconnected).off(q.receiveOffer).off(q.receiveBye).off(q.receiveAnswer).off(q.receiveIce),g=!1);F={};m=null;p.user=null;u=[];z=[];B={}});A.disconnect()},connect:function(a,c){if(!p.user)throw new b.CommonError("connect","Need to enter the room before you connect someone.");var d=s(a);if(null==d)d=b.CommonError("connect","Target user not found."),this.trigger(b.Room.events.error,
{userId:a,error:d});else{var e=c&&c.data?c.data:null;v.call(this,b.utils.newGuid(),m,d,e,function(a){a=a.connection;c&&"auto"===c.createDataChannel&&a.createDataChannel("autoDataChannel");a._open(c)})}},getInfo:function(){return p},getConnections:function(){return z.map(function(a){return a})},getUsers:function(){return u.map(function(a){return a})}})});b.Room.extend({events:{enter:"enter",leave:"leave",incomingConnection:"incomingconnection",connectionCreated:"connectioncreated",connectionAccepted:"connectionaccepted",
connectionDeclined:"connectiondeclined",usersUpdated:"usersupdated",userConnected:"userconnected",userDisconnected:"userdisconnected",tokenInvalid:"tokeninvalid",error:"error"},settings:{info:{domain:a.document.domain,application:"default",name:"default"},enterOptions:{autoReply:!0}}})})(window);xRtc.userMedia={};
(function(a){"undefined"===typeof a.xRtc&&(a.xRtc={});var b=a.xRtc,k=b.webrtc,c=new b.Logger("UserMedia"),d=function(a,c,d){k.getUserMedia(a,function(a){"function"===typeof c&&c(new b.Stream(a))},function(a){"function"===typeof d&&d(a)})};b.getUserMedia=function(a,e,r){if(a&&!a.video&&!a.audio){var v=new b.CommonError("getUserMedia","video or audio property of the options parameter should be specified. No sense to create media stream without video and audio components.");c.error("onCreateOfferError",v)}var n=
a||{video:!0,audio:!0};n.video&&n.video.mandatory&&"screen"===n.video.mandatory.mediaSource?d.call(this,{video:{mandatory:{chromeMediaSource:"screen"}}},function(a){n.audio?d.call(this,{audio:!0},function(b){function c(a,b){for(var d=0;d<b.length;d++)a.push(b[d])}var d=[];c(d,b.getAudioTracks());c(d,a.getVideoTracks());e(new k.MediaStream(d))},r):e(a)},r):d.call(this,n,e,r)}})(window);
